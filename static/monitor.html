<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Monitor</title>
    <style type="text/css">
        @import url("lib/element-ui/theme-chalk/index.css");
        body {
            margin: 0;
            color: rgb(44, 44, 44);
        }
        
        .el-table th>.cell {
            padding: 0 14px;
        }
        
        .el-table td,
        .el-table th {
            padding: 3px 0;
        }
        
        .host_status {
            margin: auto;
            width: 10px;
            height: 10px;
            border-radius: 5px;
        }
        
        .host_status_1 {
            background-color: lawngreen;
        }
        
        .host_status_0 {
            background-color: firebrick;
        }
        
        #title {
            padding: 0 10px;
            height: 64px;
            line-height: 64px;
            border-bottom: 1px solid gainsboro;
        }
        
        .el_col {
            padding: 0 10px;
            height: 100%;
        }
        
        .el_col_left {
            border-right: 1px gainsboro dashed;
            height: calc(100vh - 65px);
            overflow: scroll;
        }
        
        .el_col_right {
            height: calc(100vh - 65px);
            overflow: scroll;
            padding-bottom: 10px;
        }
        
        .el-card__body {
            padding: 0 20px;
        }
        
        pre {
            margin: 0;
            padding: 2px 20px;
        }
        
        .output_title {
            font-size: 13px;
            color: forestgreen;
        }
        
        .output_title_inner {
            font-size: 11px;
            color: forestgreen;
        }
        
        .host_group_title {
            margin-top: 15px;
            border-top: 1px gainsboro dashed;
            padding-top: 10px;
        }
        
        .btn_fixed {
            position: absolute;
            z-index: 99;
            font-size: 20px;
            top: -2px;
        }
        
        .btn_fixed_run:hover,
        .btn_fixed_run:focus {
            color: forestgreen;
        }
        
        .btn_fixed_refresh:hover,
        .btn_fixed_refresh:focus {
            color: #66b1ff;
        }
        
        .btn_fixed_run {
            right: 40px;
            color: forestgreen;
        }
        
        .btn_fixed_refresh {
            right: 10px;
            color: #66b1ff;
        }
        
        [v-cloak] {
            display: none;
        }
        
        .el-table--enable-row-transition .el-table__body td {
            padding: 0;
        }
        
        .smallTable .el-table td,
        .el-table th {
            padding: 0;
        }
        
        .el-card__body {
            padding: 0;
        }
        
        .clr_chs_btn {
            font-size: 18px;
            position: fixed;
            top: 0;
            padding: 22px 0;
        }
        
        .clr_chs_btn_left {
            right: 64px;
        }
        
        .clr_chs_btn_right {
            right: 32px;
        }
        
        .clr_chs_btn_div {
            height: 16px;
            width: 32px;
        }
        
        .clr_chs_btn_div_left {
            background-color: rgb(31, 31, 31);
        }
        
        .clr_chs_btn_div_right {
            background-color: rgb(235, 238, 244);
        }
        
        #editor {
            position: relative;
            border-radius: 4px;
        }
        
        .sticky_title {
            position: sticky;
            top: 0;
            padding: 0 20px;
        }
        
        .title_btm_dashed {
            border-bottom: 1px dashed rgb(235, 238, 244);
        }
        
        .px250_scroll {
            max-height: 250px;
            overflow: scroll;
        }
        
        .grp_inner_bdr_top {
            border: none;
            border-top: 1px solid rgb(235, 238, 244);
            border-radius: 0;
        }
        
        .margin_top_10px {
            margin-top: 10px;
        }
    </style>
</head>

<body style="background: azure;">
    <script src="lib/vue/vue.js"></script>
    <script src="lib/element-ui/index.js"></script>
    <script src="js/jquery-2.1.1.min.js"></script>
    <script src="js/ace.js"></script>
    <script src="js/ext-language_tools.js"></script>
    <script src="js/ace.hint.js"></script>
    <script type="text/javascript" src="js/echarts.min.js"></script>
    <script type="text/javascript" src="js/echarts-gl.min.js"></script>
    <script type="text/javascript" src="js/ecStat.min.js"></script>
    <script type="text/javascript" src="js/dataTool.min.js"></script>
    <script type="text/javascript" src="js/china.js"></script>
    <script type="text/javascript" src="js/world.js"></script>
    <div id="app" v-cloak>
        <el-container>
            <el-main style="padding: 0;">
                <div id="title" style="background: lightgray;">
                    <span>Monitor
                    <el-select size="mini"
                                 style="width: 246px;"
                                 v-model="lastTimeOption"
                                 placeholder=""
                                 v-on:change=query_range>
                        <el-option v-for="v,k in lastTimeOptions"
                                   :key="k"
                                   :label="k"
                                   :value="k"></el-option>
                      </el-select>
                      <el-input size="mini" v-model="processfilter" style="width: 200px;" clearable ></el-input>
                    <el-button  type="primary" size="mini" icon="el-icon-refresh" :loading="querying" @click="query_range()">刷新</el-button></span>
                </div>
                <div id="container" style="height: 500px"></div>
                <el-table ref="multipleTable" :data="tableData" tooltip-effect="dark" style="width: 100%" max-height="250" @selection-change="handleSelectionChange">
                    <el-table-column type="selection" width="55">
                    </el-table-column>
                    <el-table-column type="index" label="#" width="100">
                    </el-table-column>
                    <el-table-column prop="pid" label="PID" width="120" sortable>
                    </el-table-column>
                    <el-table-column prop="pname" label="PNAME" width="300" sortable>
                    </el-table-column>
                </el-table>
            </el-main>
        </el-container>
    </div>
    <script>
        var webSocket

        var cs = '0123456789abcdef'.split('')

        function randomColor() {
            return '#' + '0123456789abcdef'.split('').map(function(v, i, a) {
                return i > 5 ? null : a[Math.floor(Math.random() * 16)]
            }).join('');
        }

        function genColorByPid(pid) {
            var r = pid % 16
            var g = (pid + 7 * pid) % 16
            var b = (pid + 7 * pid) % 16
            return '#' + cs[r] + '' + cs[g] + '' + cs[b];
        }

        function initWebSocket() {
            webSocket.onopen = webSocketOpen;
            webSocket.onmessage = webSocketMessage;
            webSocket.onclose = webSocketClose;
            webSocket.onerror = webSocketError;
        }

        function webSocketOpen() {
            console.log("WebSocket连接成功")
            webSocket.send(JSON.stringify({
                    reqType: 10001
                })) // 请求hosts
            webSocket.send(JSON.stringify({
                    reqType: 10002
                })) // 请求groups
        }

        function webSocketMessage(e) {
            console.log(e.data)
        }

        function webSocketClose() {
            console.log("WebSocket关闭");
        }

        function webSocketError() {
            console.log("WebSocket连接失败");
        }

        function exist(s, val) {
            for (i in val) {
                if (s.name == val[i].pid) {
                    return true
                }
            }
            return false
        }

        function table_exist(s, val) {
            for (i in val) {
                if (s == val[i].pid) {
                    return true
                }
            }
            return false
        }

        // Vue.js
        var vm = new Vue({
            el: "#app",
            data: {
                hostNodes: [],
                selectHostNodes: [],
                hostsOutput: [],
                groupNodes: [],
                selectGroupNodes: [],
                groupsOutput: [],
                executing: false,
                querying: false,
                allowedRun: false,
                theme: 'white',
                useWebSocket: true,
                tableData: [],
                multipleSelection: [],
                processfilter: "Code.exe",
                lastTimeOption: "Last 5 minutes",
                lastTimeOptions: {
                    "Last 5 minutes": 5,
                    "Last 15 minutes": 15,
                    "Last 30 minutes": 30,
                    "Last 1 hour": 60,
                    "Last 2 hour": 2 * 60,
                    "Last 3 hour": 3 * 60,
                    "Last 5 hour": 5 * 60,
                    "Last 1 day": 24 * 60,
                }
            },
            mounted() {
                this.query_range(function() {
                    window.parent.vm.loading = false
                })
            },
            created() {
                if ('WebSocket' in window) {
                    this.useWebSocket = true
                    webSocket = new WebSocket('ws://' + window.location.host + '/orange');
                    initWebSocket();
                    console.log('Support webSocket')
                } else {
                    this.useWebSocket = false
                    console.log('Not support webSocket')
                }
            },
            methods: {
                toggleSelection(rows) {
                    if (rows) {
                        rows.forEach(row => {
                            this.$refs.multipleTable.toggleRowSelection(row);
                        });
                    } else {
                        this.$refs.multipleTable.clearSelection();
                    }
                },
                handleSelectionChange(val) {
                    this.multipleSelection = val;
                    if (option && typeof option === "object") {
                        var series = []
                        for (s in seriesfull) {
                            if (exist(seriesfull[s], val)) {
                                series.push(seriesfull[s])
                            }
                        }
                        option.series = series
                        myChart.setOption(option, true);
                    }
                },
                handleHostSelectionChange(val) {
                    vm.selectHostNodes = val
                    console.log(vm.selectHostNodes)
                    checkAllowedRun()
                },
                handleGroupSelectionChange(val) {
                    vm.selectGroupNodes = val
                    console.log(vm.selectGroupNodes)
                    checkAllowedRun()
                },
                checkSelectable(row, index) {
                    return row.status == 1
                },
                query_range(callback) {
                    var now = parseInt(new Date().getTime() / 1000)
                    var vmm = this
                    this.querying = true
                    $.ajax({
                        type: 'GET',
                        url: '/query_range' + '?start=' + (now - vmm.lastTimeOptions[vmm.lastTimeOption] * 60) + '&end=' + now + '&processfilter=' + vmm.processfilter,
                        async: true,
                        cache: false,
                        error: function(request) {
                            vmm.notification(vm.$t('msg.data_loading_error'), vm.$t(
                                'msg.net_error'), 'bottom-right', 'error')
                        },
                        success: function(res) {
                            handle_process_data(res)
                            vmm.querying = false
                            callback()
                        },
                        dataType: 'json'
                    })
                },
                send: function() {
                    let data = {
                        reqType: 10003,
                        target: {
                            hosts: vm.selectHostNodes,
                            groups: vm.selectGroupNodes
                        },
                        commands: {
                            "code": 1000,
                            "cmds": [editor.getValue()]
                        }
                    }
                    webSocket.send(JSON.stringify(data))
                },
                resetCmds() {
                    editor.setValue("")
                },
                changeTheme(theme) {
                    this.theme = theme
                    editor.setTheme(theme == 'white' ? 'ace/theme/xcode' : 'ace/theme/monokai');
                }
            }
        });


        function checkAllowedRun() {
            vm.allowedRun = editor.getValue().trim() && (vm.selectHostNodes.length > 0 || vm.selectGroupNodes.length > 0)
        }

        function formatdate(value) {
            let fmt = "YYYY-mm-dd HH:MM:SS";
            var date = new Date(value);
            let ret;
            const opt = {
                "Y+": date.getFullYear().toString(), // 年
                "m+": (date.getMonth() + 1).toString(), // 月
                "d+": date.getDate().toString(), // 日
                "H+": date.getHours().toString(), // 时
                "M+": date.getMinutes().toString(), // 分
                "S+": date.getSeconds().toString() // 秒
            };
            for (let k in opt) {
                ret = new RegExp("(" + k + ")").exec(fmt);
                if (ret) {
                    fmt = fmt.replace(ret[1], (ret[1].length == 1) ? (opt[k]) : (opt[k].padStart(ret[1].length, "0")))
                };
            };
            return fmt
        }


        var tms = []
        var last = 0
        var pids = new Set()
        var option = null
        var seriesfull = []
        var dom = document.getElementById("container");
        var myChart = echarts.init(dom);

        function handle_process_data(data) {
            var data_map = {}
            tms = []
            pids = new Set()
            vm.tableData = []
            for (d in data) {
                t = data[d][0] * 1000
                pid = data[d][1]
                pname = data[d][2]
                mem = data[d][3]
                if (last != t) {
                    tms.push(t)
                    last = t
                }
                if (!data_map[pid]) {
                    data_map[pid] = []
                }
                data_map[pid].push([t, mem])
                if (!pids.has(pid)) {
                    vm.tableData.push({
                        pid: pid,
                        pname: pname
                    })
                    pids.add(pid)
                }
            }
            // gen seris
            var series = []


            for (pid in data_map) {
                var c = genColorByPid(pid)
                var ss = {
                    name: pid,
                    type: 'line',
                    smooth: true,
                    symbol: 'none',
                    sampling: 'average',
                    itemStyle: {
                        color: c
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                            offset: 0,
                            color: c
                        }, {
                            offset: 1,
                            color: c
                        }])
                    },
                    data: data_map[pid]
                }
                series.push(ss)
                seriesfull.push(ss)
            }
            option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: (params) => {
                        params.sort(function(a, b) {
                            return b.data[1] - a.data[1]
                        })
                        var d = []
                        d.push(formatdate(params[0].axisValue) + '<br>')
                        params.forEach(e => {
                            d.push('<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:' + e.color + ';"></span> ' + e.seriesName + ' : ' + e.data[1])
                        })
                        return d.join('<br>')
                    },
                    extraCssText: 'box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);',
                    position: function(pt) {
                        return [pt[0], '10%'];
                    }
                },
                title: {
                    left: 'center',
                    text: 'Memory Used For Every Process',
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: 'none'
                        },
                        restore: {},
                        saveAsImage: {}
                    }
                },
                xAxis: {
                    type: 'time',
                    boundaryGap: false,
                    interval: vm.lastTimeOptions[vm.lastTimeOption] * 6 * 1000,
                    data: tms,
                    axisLabel: {
                        formatter: function(value, index) {
                            return formatdate(value);
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    boundaryGap: [0, '100%']
                },
                dataZoom: [{
                    type: 'inside',
                    // start: 0,
                    // end: 10
                }, {
                    start: 0,
                    end: 10,
                    handleIcon: 'M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                    handleSize: '80%',
                    handleStyle: {
                        color: '#000',
                        shadowBlur: 3,
                        shadowColor: 'rgba(0, 0, 0, 0.6)',
                        shadowOffsetX: 2,
                        shadowOffsetY: 2
                    }
                }],
                series: series
            }
            if (option && typeof option === "object") {
                myChart.setOption(option, true);
            }
        }
    </script>
</body>

</html>