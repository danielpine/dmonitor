<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Monitor</title>
    <style type="text/css">
        @import url("lib/element-ui/theme-chalk/index.css");
        body {
            margin: 0;
            color: rgb(44, 44, 44);
        }
        
        .el-table th>.cell {
            padding: 0 14px;
        }
        
        .el-table td,
        .el-table th {
            padding: 3px 0;
        }
        
        .host_status {
            margin: auto;
            width: 10px;
            height: 10px;
            border-radius: 5px;
        }
        
        .host_status_1 {
            background-color: lawngreen;
        }
        
        .host_status_0 {
            background-color: firebrick;
        }
        
        #title {
            padding: 0 10px;
            height: 64px;
            line-height: 64px;
            border-bottom: 1px solid gainsboro;
        }
        
        .el_col {
            padding: 0 10px;
            height: 100%;
        }
        
        .el_col_left {
            border-right: 1px gainsboro dashed;
            height: calc(100vh - 65px);
            overflow: scroll;
        }
        
        .el_col_right {
            height: calc(100vh - 65px);
            overflow: scroll;
            padding-bottom: 10px;
        }
        
        .el-card__body {
            padding: 0 20px;
        }
        
        pre {
            margin: 0;
            padding: 2px 20px;
        }
        
        .output_title {
            font-size: 13px;
            color: forestgreen;
        }
        
        .output_title_inner {
            font-size: 11px;
            color: forestgreen;
        }
        
        .host_group_title {
            margin-top: 15px;
            border-top: 1px gainsboro dashed;
            padding-top: 10px;
        }
        
        .btn_fixed {
            position: absolute;
            z-index: 99;
            font-size: 20px;
            top: -2px;
        }
        
        .btn_fixed_run:hover,
        .btn_fixed_run:focus {
            color: forestgreen;
        }
        
        .btn_fixed_refresh:hover,
        .btn_fixed_refresh:focus {
            color: #66b1ff;
        }
        
        .btn_fixed_run {
            right: 40px;
            color: forestgreen;
        }
        
        .btn_fixed_refresh {
            right: 10px;
            color: #66b1ff;
        }
        
        [v-cloak] {
            display: none;
        }
        
        .el-table--enable-row-transition .el-table__body td {
            padding: 0;
        }
        
        .smallTable .el-table td,
        .el-table th {
            padding: 0;
        }
        
        .el-card__body {
            padding: 0;
        }
        
        .clr_chs_btn {
            font-size: 18px;
            position: fixed;
            top: 0;
            padding: 22px 0;
        }
        
        .clr_chs_btn_left {
            right: 64px;
        }
        
        .clr_chs_btn_right {
            right: 32px;
        }
        
        .clr_chs_btn_div {
            height: 16px;
            width: 32px;
        }
        
        .clr_chs_btn_div_left {
            background-color: rgb(31, 31, 31);
        }
        
        .clr_chs_btn_div_right {
            background-color: rgb(235, 238, 244);
        }
        
        #editor {
            position: relative;
            border-radius: 4px;
        }
        
        .sticky_title {
            position: sticky;
            top: 0;
            padding: 0 20px;
        }
        
        .title_btm_dashed {
            border-bottom: 1px dashed rgb(235, 238, 244);
        }
        
        .px250_scroll {
            max-height: 250px;
            overflow: scroll;
        }
        
        .grp_inner_bdr_top {
            border: none;
            border-top: 1px solid rgb(235, 238, 244);
            border-radius: 0;
        }
        
        .margin_top_10px {
            margin-top: 10px;
        }
    </style>
</head>

<body style="background: black;">
    <script src="lib/vue/vue.js"></script>
    <script src="lib/element-ui/index.js"></script>
    <script src="js/jquery-2.1.1.min.js"></script>
    <script src="js/ace.js"></script>
    <script src="js/ext-language_tools.js"></script>
    <script src="js/ace.hint.js"></script>
    <div id="app" v-cloak>
        <el-container>
            <el-main style="padding: 0;">
                <div id="title" style="background: lightgray;">
                    <span>Monitor</span>
                </div>
                <div>
                    <el-row>
                        monitors
                    </el-row>
                </div>
            </el-main>
        </el-container>
    </div>
    <script>
        var webSocket

        function initWebSocket() {
            webSocket.onopen = webSocketOpen;
            webSocket.onmessage = webSocketMessage;
            webSocket.onclose = webSocketClose;
            webSocket.onerror = webSocketError;
        }

        function webSocketOpen() {
            console.log("WebSocket连接成功")
            webSocket.send(JSON.stringify({
                    reqType: 10001
                })) // 请求hosts
            webSocket.send(JSON.stringify({
                    reqType: 10002
                })) // 请求groups
        }

        function webSocketMessage(e) {
            let respMsgJson = JSON.parse(e.data);
            console.log(respMsgJson)
            switch (respMsgJson['respType']) {
                case 10001: // 请求hosts
                    vm.hostNodes = respMsgJson.data
                    break
                case 10002: // 请求groups
                    vm.groupNodes = respMsgJson.data
                    break
                case 10003: // 执行命令
                    vm.hostsOutput = respMsgJson.hosts ? respMsgJson.hosts : []
                    vm.groupsOutput = respMsgJson.groups ? respMsgJson.groups : []
                    break
                default:
                    console.log(e)
                    break
            }
        }

        function webSocketClose() {
            console.log("WebSocket关闭");
        }

        function webSocketError() {
            console.log("WebSocket连接失败");
        }

        // Vue.js
        var vm = new Vue({
            el: "#app",
            data: {
                hostNodes: [],
                selectHostNodes: [],
                hostsOutput: [],
                groupNodes: [],
                selectGroupNodes: [],
                groupsOutput: [],
                executing: false,
                allowedRun: false,
                theme: 'white',
                useWebSocket: true
            },
            mounted() {
                window.parent.vm.loading = false
            },
            created() {
                if ('WebSocket' in window) {
                    this.useWebSocket = true
                    webSocket = new WebSocket('ws://' + window.location.host + '/orange');
                    initWebSocket();
                    console.log('Support webSocket')
                } else {
                    this.useWebSocket = false
                    console.log('Not support webSocket')
                }
            },
            methods: {
                handleHostSelectionChange(val) {
                    vm.selectHostNodes = val
                    console.log(vm.selectHostNodes)
                    checkAllowedRun()
                },
                handleGroupSelectionChange(val) {
                    vm.selectGroupNodes = val
                    console.log(vm.selectGroupNodes)
                    checkAllowedRun()
                },
                checkSelectable(row, index) {
                    return row.status == 1
                },
                send: function() {
                    let data = {
                        reqType: 10003,
                        target: {
                            hosts: vm.selectHostNodes,
                            groups: vm.selectGroupNodes
                        },
                        commands: {
                            "code": 1000,
                            "cmds": [editor.getValue()]
                        }
                    }
                    webSocket.send(JSON.stringify(data))
                },
                resetCmds() {
                    editor.setValue("")
                },
                changeTheme(theme) {
                    this.theme = theme
                    editor.setTheme(theme == 'white' ? 'ace/theme/xcode' : 'ace/theme/monokai');
                }
            }
        });


        function checkAllowedRun() {
            vm.allowedRun = editor.getValue().trim() && (vm.selectHostNodes.length > 0 || vm.selectGroupNodes.length > 0)
        }
    </script>
</body>

</html>